<html>
<head>
<meta charset="UTF-8"> 
<title>Sensors</title>

<link rel="stylesheet" type="text/css" href="mystyle.css">

<link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">
<link type="text/css" rel="stylesheet" href="css/graph.css">
<link type="text/css" rel="stylesheet" href="css/detail.css">
<link type="text/css" rel="stylesheet" href="css/legend.css">
<link type="text/css" rel="stylesheet" href="css/lines.css">

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>  
<script src="http://d23cj0cdvyoxg0.cloudfront.net/xivelyjs-1.0.4.min.js"></script>  
<script type='text/javascript' src='js/tween.js'></script>
<script type='text/javascript' src='js/steelseries.js'></script>
<script src="vendor/d3.min.js"></script>
<script src="vendor/d3.layout.min.js"></script>
<script src="rickshaw.min.js"></script>
<script src="vendor/moment.min.js"></script>

<script src="http://code.shutterstock.com/rickshaw/src/js/Rickshaw.Fixtures.Time.Local.js"></script>
<script src="http://code.shutterstock.com/rickshaw/src/js/Rickshaw.Graph.Smoother.js"></script>
<script src="http://code.shutterstock.com/rickshaw/src/js/Rickshaw.Graph.RangeSlider.js"></script>
<script src="http://code.shutterstock.com/rickshaw/src/js/Rickshaw.Graph.RangeSlider.Preview.js"></script>

<script type="text/javascript" charset="UTF-8">
  // Make sure the document is ready to be handled
  $(document).ready(function($) {
    // Set the Xively API key (https://xively.com/users/YOUR_USERNAME/keys)
    xively.setKey( "SICanKXlrENyrCh3cYsdBZTjmoxH39kujPYRGnJGnZ7bVM8k" );

    // Replace with your own values
    var feedID        = "302281936",          // Feed ID (the last number on the URL on the feed page on Xively)
    poolDatastreamID  = "PoolTemperatureF";       // Datastream ID
    outDatastreamID   = "ExteriorTemperature";

    var valGradF = new steelseries.gradientWrapper( 65,
                                                    90,
                                                    [ 0, 0.33, 0.66, 0.85, 1],
                                                    [ new steelseries.rgbaColor(0, 0, 200, 1),
                                                      new steelseries.rgbaColor(0, 200, 0, 1),
                                                      new steelseries.rgbaColor(200, 200, 0, 1),
                                                      new steelseries.rgbaColor(200, 0, 0, 1),
                                                      new steelseries.rgbaColor(200, 0, 0, 1) ]);
    var valGradC = new steelseries.gradientWrapper( 10,
                                                    40,
                                                    [ 0, 0.33, 0.66, 0.85, 1],
                                                    [ new steelseries.rgbaColor(0, 0, 200, 1),
                                                      new steelseries.rgbaColor(0, 200, 0, 1),
                                                      new steelseries.rgbaColor(200, 200, 0, 1),
                                                      new steelseries.rgbaColor(200, 0, 0, 1),
                                                      new steelseries.rgbaColor(200, 0, 0, 1) ]);
    pool = new steelseries.LinearBargraph('poolThermometerCanvas', {
             width: 140,
             height: 320,
             valueGradient: valGradF,
             useValueGradient: true,
             minValue: 65,
             maxValue: 90,
             gaugeType: steelseries.GaugeType.TYPE2,
             titleString: 'Piscine',
             unitString: '°F',
             thresholdVisible: false,
             lcdVisible: true,
             minMeasuredValueVisible: true,
             maxMeasuredValueVisible: true,
             //MinMeasuredValue: 65,
             //MaxMeasuredValue: 90
    }); 

    out = new steelseries.LinearBargraph('outThermometerCanvas', {
            width: 140,
            height: 320,
            valueGradient: valGradC,
            useValueGradient: true,
            minValue: 10,
            maxValue: 40,
            gaugeType: steelseries.GaugeType.TYPE2,
            titleString: 'Extérieur',
            unitString: '°C',
            thresholdVisible: false,
            lcdVisible: true,
            minMeasuredValueVisible: true,
            maxMeasuredValueVisible: true,
            //MaxMeasuredValue: 40,
            //MinMeasuredValue: 10
    });


    // Get datastream data from Xively
    xively.datastream.get (feedID, poolDatastreamID, function ( datastream ) {
      // WARNING: This code is only executed when we get a response back from Xively, it will likely execute after the rest your script
      // NOTE: The variable "datastream" will contain all the Datastream information as an object. The structure of Datastream objects can be found at: 
      // https://xively.com/dev/docs/api/quick_reference/api_resource_attributes/#datastream


      // Display the current value from the datastream
      var my_pool_current_value = (datastream["current_value"]);

      //alert("About to display [" + my_pool_current_value + "]");
      //tempGauge.setValueAnimated( my_pool_current_value );
      pool.setValueAnimated( my_pool_current_value );

      // Getting realtime! The function associated with the subscribe method will be executed every time there is an update to the datastream
      xively.datastream.subscribe( feedID, poolDatastreamID, function ( event , datastream_updated ) {
        // Display the current value from the updated datastream
        //tempGauge.setValueAnimated( my_pool_current_value );
        pool.setValueAnimated( my_pool_current_value );
      });
    });

    xively.datastream.get (feedID, outDatastreamID, function ( datastream ) {
      // WARNING: This code is only executed when we get a response back from Xively, it will likely execute after the rest your script
      // NOTE: The variable "datastream" will contain all the Datastream information as an object. The structure of Datastream objects can be found at:
      // https://xively.com/dev/docs/api/quick_reference/api_resource_attributes/#datastream

      // Display the current value from the datastream
      var my_out_current_value = (datastream["current_value"]);
      //alert("About to display [" + my_pool_current_value + "]");
      out.setValueAnimated( my_out_current_value );

      // Getting realtime! The function associated with the subscribe method will be executed every time there is an update to the datastream
      xively.datastream.subscribe( feedID, outDatastreamID, function ( event , datastream_updated ) {
        // Display the current value from the updated datastream
        pool.setValueAnimated( my_out_current_value );
      });
    });

    // WARNING: Code here will continue executing while we get the datastream data from Xively, use the function associated with datastream.get to work with the data, when the request is complete
  });

  function init(){
    //alert("here I am in init");

    //tempGauge.setValueAnimated(20.90);
  }

  ///// Rickshaw /////
  // Set your API key first
  xively.setKey( "SICanKXlrENyrCh3cYsdBZTjmoxH39kujPYRGnJGnZ7bVM8k" );

//  var startOfYesterday = moment().subtract("day", 1).startOf('day');
// var endOfYesterday = moment().subtract("hour", 3).startOf('day');
  var startOfYesterday = moment().subtract("day", 1);
//  var endOfYesterday = moment();
//  var startDaily = moment().subtract("day", 1);
  var startWeekly = moment().subtract("week", 1);
  var now = moment();
  var PoolC_series = [];
  var PoolF_series = [];
  var OutC_series = [];
  var OutF_series = [];
  var PoolC_seriesW = [];
  var PoolF_seriesW = [];
  var OutC_seriesW = [];
  var OutF_seriesW = [];

  console.log(now);
  console.log(startOfYesterday);
  console.log(startWeekly);

  var queryDaily = {
    //start: startOfYesterday.toJSON(),
    start: startiWeekly.toJSON(),
    end: now.toJSON(),
    interval: 300,
    //limit: 288,
    limit: 6912,
  };

/*
  var queryWeekly = {
    start: startWeekly.toJSON(),
    end: now.toJSON(),
    interval: 300,
    limit: 5000,
  };
*/

  xively.datastream.history( "302281936", "PoolTemperature", queryDaily, loadData);
  xively.datastream.history( "302281936", "ExteriorTemperature", queryDaily, loadData);
  xively.datastream.history( "302281936", "PoolTemperatureF", queryDaily, loadData);
  xively.datastream.history( "302281936", "ExteriorTemperatureF", queryDaily, loadData);

  function loadData(data) {
    //var unit = data.unit.label;
    var filtedData = data.datapoints;
    for (var i=0; i < filtedData.length; i++ ) {
      var date = moment(filtedData[i].at);
      var value = parseFloat(filtedData[i].value);
      switch (data.id) {
        case "PoolTemperature":
          PoolC_series[i] = {x: date.unix(), y: value};
          if (PoolC_series.length == OutC_series.length) {
            drawgraphifready(PoolC_series , OutC_series , "#chartC");
          }
          break;
        case "PoolTemperatureF":
          PoolF_series[i] = {x: date.unix(), y: value};
          if (PoolF_series.length == OutF_series.length) {
            drawgraphifready(PoolF_series , OutF_series , "#chartF");
          }
          break;
        case "ExteriorTemperature":
          OutC_series[i] = {x: date.unix(), y: value};
          if (PoolC_series.length == OutC_series.length) {
            drawgraphifready(PoolC_series , OutC_series , "#chartC");
          }
          break;
        case "ExteriorTemperatureF":
          OutF_series[i] = {x: date.unix(), y: value};
          if (PoolF_series.length == OutF_series.length) {
            drawgraphifready(PoolF_series , OutF_series , "#chartF");
          }
          break;
        default:
          console.log("default")
      }
    }
  }

/*
  xively.datastream.history( "302281936", "PoolTemperature", queryWeekly, loadDataW);
  xively.datastream.history( "302281936", "ExteriorTemperature", queryWeekly, loadDataW);
  xively.datastream.history( "302281936", "PoolTemperatureF", queryWeekly, loadDataW);
  xively.datastream.history( "302281936", "ExteriorTemperatureF", queryWeekly, loadDataW);

  function loadDataW(data) {
    //var unit = data.unit.label;
    var filtedData = data.datapoints;
    for (var i=0; i < filtedData.length; i++ ) {
      var date = moment(filtedData[i].at);
      var value = parseFloat(filtedData[i].value);
      switch (data.id) {
        case "PoolTemperature":
          PoolC_seriesW[i] = {x: date.unix(), y: value};
          if (PoolC_seriesW.length == OutC_seriesW.length) {
            drawgraphifready(PoolC_seriesW , OutC_seriesW , data.min_value , data.max_value  , "#chartCW");
          }
          break;
        case "PoolTemperatureF":
          PoolF_seriesW[i] = {x: date.unix(), y: value};
          if (PoolF_seriesW.length == OutF_seriesW.length) {
            drawgraphifready(PoolF_seriesW , OutF_seriesW , data.min_value , data.max_value  , "#chartFW");
          }
          break;
        case "ExteriorTemperature":
          OutC_seriesW[i] = {x: date.unix(), y: value};
          if (PoolC_seriesW.length == OutC_seriesW.length) {
            drawgraphifready(PoolC_seriesW , OutC_seriesW , data.min_value , data.max_value  , "#chartCW");
          }
          break;
        case "ExteriorTemperatureF":
          OutF_seriesW[i] = {x: date.unix(), y: value};
          if (PoolF_seriesW.length == OutF_seriesW.length) {
            drawgraphifready(PoolF_seriesW , OutF_seriesW , data.min_value , data.max_value  , "#chartFW");
          }
          break;
        default:
          console.log("default")
      }
    }
  }
*/

  function drawgraphifready(serie1, serie2, anchor) {
    console.log("Entered drawgraphifready: " + serie1.length + " - " + serie2.length);
    if ((serie1.length > 0) && (serie2.length > 0)){
      var graph = new Rickshaw.Graph( {
        element: document.querySelector(anchor),
        width: 640,
        height: 400,
        renderer: 'line',
  //      interpolation: 'basis',
        series: [
          {
            data: serie1,
            color: '#6060c0',
            name: "Piscine"
          },
          {
            data: serie2,
            color: '#FF0000',
            name: "Exterieur"
          },
        ]
      } );

      graph.render();

      var hoverDetail = new Rickshaw.Graph.HoverDetail( {
        graph: graph
      } );
/*
      var smoother = new Rickshaw.Graph.Smoother( {
	graph: graph,
	element: document.querySelector('#smoother')
      } );

      var ticksTreatment = 'glow';
*/
      var axes = new Rickshaw.Graph.Axis.Time( {
        graph: graph,
        //ticksTreatment: ticksTreatment,
	//timeFixture: new Rickshaw.Fixtures.Time.Local()
      });
      axes.render();

      var yAxis = new Rickshaw.Graph.Axis.Y({
        graph: graph
      });

      yAxis.render();
    }
  }
</script>

</head>

<body onload=init()>

<!--<strong>Home</strong> - <a href="weekly.html">Weekly</a> - <a href="daily.html">Daily</a> - <a href="hourly.html">Hourly</a>-->

<div align="center" style="vertical-align:bottom">

<h2>Les derni&egrave;res 24 heures</h2>
<table width="70%">
  <tr>
    <td>
<table id="graph">
  <tr>
    <td><div id="div_temp_chart_cm"> <img src="https://api.xively.com/v2/feeds/302281936/datastreams/PoolTemperatureF.png?width=750&height=320&colour=%23f15a24&duration=24hours&show_axis_labels=true&detailed_grid=true&timezone=America/Montreal" ></div></td>
    <td><canvas id=poolThermometerCanvas width=200 height=200>No canvas in your browser...sorry...</canvas></td>
  </tr>
  <tr>
    <td><img src="https://api.xively.com/v2/feeds/302281936/datastreams/ExteriorTemperature.png?width=750&height=320&colour=%23f15a24&duration=24hours&show_axis_labels=true&detailed_grid=true&timezone=America/Montreal" ></td>
    <td><canvas id=outThermometerCanvas width=200 height=200>No canvas in your browser...sorry...</canvas></td>
  </tr>
</table>
    </td>
  </tr>
</table>

<h2>La derni&egrave;re journ&eacute;e</h2>
<table width="70%">
  <tr>
    <td>
<table id="graph">
  <tr>
    <th align="center">Combin&eacute;e °C</th>
    <th align="center">Combin&eacute;e °F</th>
  <tr>
    <td>
      <div id="chart_container" >
        <div id="chartC"></div>
          <div id="legend_container">
          <div id="timeline"></div>
          <div id="preview"></div>
          <div id="smoother" title="Smoothing"></div>
          <div id="legend"></div>
        </div>
      </div>
    </td>
    <td>
      <div id="chart_container" >
        <div id="chartF"></div>
        <div id="legend_container">
          <div id="smoother" title="Smoothing"></div>
          <div id="legend"></div>
        </div>
      </div>
    </td>
<!--
    <td><a href="temp_combined_c_day.png"><img src="temp_combined_c_day.png"></a></td>
    <td><a href="temp_combined_f_day.png"><img src="temp_combined_f_day.png"></a></td>
-->
  </tr>
</table>
    </td>
  </tr>
</table>

<h2>La derni&egrave;re semaine</h2>
<table width="70%">
  <tr>
    <td>
<table id="graph">
  <tr>
  <tr>
    <td>
      <div id="chart_container" >
        <div id="chartCW"></div>
        <div id="legend_container">
          <div id="smoother" title="Smoothing"></div>
          <div id="legend"></div>
        </div>
      </div>
    </td>
    <td>
      <div id="chart_container" >
        <div id="chartFw"></div>
        <div id="legend_container">
          <div id="smoother" title="Smoothing"></div>
          <div id="legend"></div>
        </div>
      </div>
    </td>
<!--
    <td><a href="temp_combined_c_week.png"><img src="temp_combined_c_week.png"></a></td>
    <td><a href="temp_combined_f_week.png"><img src="temp_combined_f_week.png"></a></td>
-->
  </tr>
</table>
    </td>
  </tr>
</table>

</body>
</html>
