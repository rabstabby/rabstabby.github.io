<html>
<head>
<meta charset="UTF-8"> 
<title>Sensors</title>

<link rel="stylesheet" type="text/css" href="mystyle.css">

<link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">
<link type="text/css" rel="stylesheet" href="css/graph.css">
<link type="text/css" rel="stylesheet" href="css/detail.css">
<link type="text/css" rel="stylesheet" href="css/legend.css">
<link type="text/css" rel="stylesheet" href="css/lines.css">

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>  
<script src="http://d23cj0cdvyoxg0.cloudfront.net/xivelyjs-1.0.4.min.js"></script>  
<script type='text/javascript' src='js/tween.js'></script>
<script type='text/javascript' src='js/steelseries.js'></script>
<script src="vendor/d3.min.js"></script>
<script src="vendor/d3.layout.min.js"></script>
<script src="rickshaw.min.js"></script>
<script src="vendor/moment.min.js"></script>

<script src="http://code.shutterstock.com/rickshaw/src/js/Rickshaw.Fixtures.Time.Local.js"></script>
<script src="http://code.shutterstock.com/rickshaw/src/js/Rickshaw.Graph.Smoother.js"></script>
<script src="http://code.shutterstock.com/rickshaw/src/js/Rickshaw.Graph.RangeSlider.js"></script>
<script src="http://code.shutterstock.com/rickshaw/src/js/Rickshaw.Graph.RangeSlider.Preview.js"></script>

<script type="text/javascript" charset="UTF-8">

  // Make sure the document is ready to be handled
  $(document).ready(function($) {

/*
    // Set the Xively API key (https://xively.com/users/YOUR_USERNAME/keys)

    xively.setKey( "SICanKXlrENyrCh3cYsdBZTjmoxH39kujPYRGnJGnZ7bVM8k" );

    // Replace with your own values
    var feedID        = "302281936",          // Feed ID (the last number on the URL on the feed page on Xively)
    poolDatastreamID  = "PoolTemperatureF";       // Datastream ID
    outDatastreamID   = "ExteriorTemperature";

    var valGradF = new steelseries.gradientWrapper( 65,
                                                    90,
                                                    [ 0, 0.33, 0.66, 0.85, 1],
                                                    [ new steelseries.rgbaColor(0, 0, 200, 1),
                                                      new steelseries.rgbaColor(0, 200, 0, 1),
                                                      new steelseries.rgbaColor(200, 200, 0, 1),
                                                      new steelseries.rgbaColor(200, 0, 0, 1),
                                                      new steelseries.rgbaColor(200, 0, 0, 1) ]);
    var valGradC = new steelseries.gradientWrapper( 10,
                                                    40,
                                                    [ 0, 0.33, 0.66, 0.85, 1],
                                                    [ new steelseries.rgbaColor(0, 0, 200, 1),
                                                      new steelseries.rgbaColor(0, 200, 0, 1),
                                                      new steelseries.rgbaColor(200, 200, 0, 1),
                                                      new steelseries.rgbaColor(200, 0, 0, 1),
                                                      new steelseries.rgbaColor(200, 0, 0, 1) ]);
    pool = new steelseries.LinearBargraph('poolThermometerCanvas', {
             width: 140,
             height: 320,
             valueGradient: valGradF,
             useValueGradient: true,
             minValue: 65,
             maxValue: 90,
             gaugeType: steelseries.GaugeType.TYPE2,
             titleString: 'Piscine',
             unitString: '°F',
             thresholdVisible: false,
             lcdVisible: true,
             minMeasuredValueVisible: true,
             maxMeasuredValueVisible: true,
             //MinMeasuredValue: 65,
             //MaxMeasuredValue: 90
    }); 

    out = new steelseries.LinearBargraph('outThermometerCanvas', {
            width: 140,
            height: 320,
            valueGradient: valGradC,
            useValueGradient: true,
            minValue: 10,
            maxValue: 40,
            gaugeType: steelseries.GaugeType.TYPE2,
            titleString: 'Extérieur',
            unitString: '°C',
            thresholdVisible: false,
            lcdVisible: true,
            minMeasuredValueVisible: true,
            maxMeasuredValueVisible: true,
            //MaxMeasuredValue: 40,
            //MinMeasuredValue: 10
    });

    // Get datastream data from Xively
    xively.datastream.get (feedID, poolDatastreamID, function ( datastream ) {
      // WARNING: This code is only executed when we get a response back from Xively, it will likely execute after the rest your script
      // NOTE: The variable "datastream" will contain all the Datastream information as an object. The structure of Datastream objects can be found at: 
      // https://xively.com/dev/docs/api/quick_reference/api_resource_attributes/#datastream


      // Display the current value from the datastream
      var my_pool_current_value = (datastream["current_value"]);

      //alert("About to display [" + my_pool_current_value + "]");
      //tempGauge.setValueAnimated( my_pool_current_value );
      pool.setValueAnimated( my_pool_current_value );

      // Getting realtime! The function associated with the subscribe method will be executed every time there is an update to the datastream
      xively.datastream.subscribe( feedID, poolDatastreamID, function ( event , datastream_updated ) {
        // Display the current value from the updated datastream
        //tempGauge.setValueAnimated( my_pool_current_value );
        pool.setValueAnimated( my_pool_current_value );
      });
    });

    xively.datastream.get (feedID, outDatastreamID, function ( datastream ) {
      // WARNING: This code is only executed when we get a response back from Xively, it will likely execute after the rest your script
      // NOTE: The variable "datastream" will contain all the Datastream information as an object. The structure of Datastream objects can be found at:
      // https://xively.com/dev/docs/api/quick_reference/api_resource_attributes/#datastream

      // Display the current value from the datastream
      var my_out_current_value = (datastream["current_value"]);
      //alert("About to display [" + my_pool_current_value + "]");
      out.setValueAnimated( my_out_current_value );

      // Getting realtime! The function associated with the subscribe method will be executed every time there is an update to the datastream
      xively.datastream.subscribe( feedID, outDatastreamID, function ( event , datastream_updated ) {
        // Display the current value from the updated datastream
        out.setValueAnimated( my_out_current_value );
      });
    });

    // WARNING: Code here will continue executing while we get the datastream data from Xively, use the function associated with datastream.get to work with the data, when the request is complete
  });
*/
  ///// Rickshaw /////
  // Set your API key first
  xively.setKey( "SICanKXlrENyrCh3cYsdBZTjmoxH39kujPYRGnJGnZ7bVM8k" );

  var startOfYesterday = moment().subtract("day", 1);
  // it seams there is a limit of <5 days for and historical query
  var startWeekly = moment().subtract("day", 4); 
  var now = moment();
  var PoolC_series = [];
  var PoolC_serie_min = 1000;
  var PoolC_serie_max = -1000;
  var PoolF_series = [];
  var PoolF_serie_min = 1000;
  var PoolF_serie_max = -1000;
  var OutC_series = [];
  var OutC_serie_min = 1000;
  var OutC_serie_max = -1000;
  var OutF_series = [];
  var OutF_serie_min = 1000;
  var OutF_serie_max = -1000;

  var PoolC_seriesW = [];
  var PoolC_serieW_min = 1000;
  var PoolC_serieW_max = -1000;
  var PoolF_seriesW = [];
  var PoolF_serieW_min = 1000;
  var PoolF_serieW_max = -1000;
  var OutC_seriesW = [];
  var OutC_serieW_min = 1000;
  var OutC_serieW_max = -1000;
  var OutF_seriesW = [];
  var OutF_serieW_min = 1000;
  var OutF_serieW_max = -1000;

  var valGradF = new steelseries.gradientWrapper( 65,
                                                  90,
                                                  [ 0, 0.33, 0.66, 0.85, 1],
                                                  [ new steelseries.rgbaColor(0, 0, 200, 1),
                                                    new steelseries.rgbaColor(0, 200, 0, 1),
                                                    new steelseries.rgbaColor(200, 200, 0, 1),
                                                    new steelseries.rgbaColor(200, 0, 0, 1),
                                                    new steelseries.rgbaColor(200, 0, 0, 1) ]);
  var valGradC = new steelseries.gradientWrapper( 10,
                                                  40,
                                                  [ 0, 0.33, 0.66, 0.85, 1],
                                                  [ new steelseries.rgbaColor(0, 0, 200, 1),
                                                    new steelseries.rgbaColor(0, 200, 0, 1),
                                                    new steelseries.rgbaColor(200, 200, 0, 1),
                                                    new steelseries.rgbaColor(200, 0, 0, 1),
                                                    new steelseries.rgbaColor(200, 0, 0, 1) ]);
  pool = new steelseries.LinearBargraph('poolThermometerCanvas', {
           width: 140,
           height: 320,
           valueGradient: valGradF,
           useValueGradient: true,
           minValue: 65,
           maxValue: 90,
           gaugeType: steelseries.GaugeType.TYPE2,
           titleString: 'Piscine',
           unitString: '°F',
           thresholdVisible: false,
           lcdVisible: true,
           minMeasuredValueVisible: true,
           maxMeasuredValueVisible: true,
           //MinMeasuredValue: 65,
           //MaxMeasuredValue: 90
  });

  out = new steelseries.LinearBargraph('outThermometerCanvas', {
          width: 140,
          height: 320,
          valueGradient: valGradC,
          useValueGradient: true,
          minValue: 10,
          maxValue: 40,
          gaugeType: steelseries.GaugeType.TYPE2,
          titleString: 'Extérieur',
          unitString: '°C',
          thresholdVisible: false,
          lcdVisible: true,
          minMeasuredValueVisible: true,
          maxMeasuredValueVisible: true,
          //MaxMeasuredValue: 40,
          //MinMeasuredValue: 10
    });

  console.log(now);
  console.log(startOfYesterday);
  console.log(startWeekly);

  var queryDaily = {
    start: startOfYesterday.toJSON(),
    end: now.toJSON(),
    interval: 300,
    limit: 1000,
  };

  var queryWeekly = {
    start: startWeekly.toJSON(),
    end: now.toJSON(),
    interval: 300,
    limit: 1000,
  };

  xively.datastream.history( "302281936", "PoolTemperature", queryDaily, loadData);
  xively.datastream.history( "302281936", "ExteriorTemperature", queryDaily, loadData);

  function loadData(data) {
    var filtedData = data.datapoints;
    for (var i=0; i < filtedData.length; i++ ) {
      var date = moment(filtedData[i].at);
      var value = parseFloat(filtedData[i].value);
      switch (data.id) {
        case "PoolTemperature":
          PoolC_series[i] = {x: date.unix(), y: value};
          if (value < PoolC_serie_min) {
            PoolC_serie_min = value;
            PoolF_serie_min = ((value * (9/5)) + 32);
          }
          if (value > PoolC_serie_max) {
            PoolC_serie_max = value;
            PoolF_serie_max = ((value * (9/5)) + 32);
          }
          PoolF_series[i] = {x: date.unix(), y: ((value * (9/5)) + 32)};
          break;
        case "ExteriorTemperature":
          OutC_series[i] = {x: date.unix(), y: value};
          if (value < OutC_serie_min) {
            OutC_serie_min = value;
            OutF_serie_min = ((value * (9/5)) + 32);
          }
          if (value > OutC_serie_max) {
            OutC_serie_max = value;
            OutF_serie_max = ((value * (9/5)) + 32);
          }
          OutF_series[i] = {x: date.unix(), y: ((value * (9/5)) + 32)};
          break;
        default:
          console.log("default")
      }
    }

    switch (data.id) {
      case "PoolTemperature":
        if (parseFloat(data.current_value) < PoolC_serie_min) {
          PoolC_serie_min = parseFloat(data.current_value);
          PoolF_serie_min = ((parseFloat(data.current_value) * (9/5)) + 32);
        }
        if (parseFloat(data.current_value) > PoolC_serie_max) {
          PoolC_serie_max = parseFloat(data.current_value);
          PoolF_serie_max = ((parseFloat(data.current_value) * (9/5)) + 32);
        }
        pool.setValueAnimated( (parseFloat(data.current_value) * (9/5)) + 32 );
        break;
      case "ExteriorTemperature":
        if (parseFloat(data.current_value) < OutC_serie_min) {
          OutC_serie_min = parseFloat(data.current_value);
          OutF_serie_min = ((parseFloat(data.current_value) * (9/5)) + 32);
        }
        if (parseFloat(data.current_value) > OutC_serie_max) {
          OutC_serie_max = parseFloat(data.current_value);
          OutF_serie_max = ((parseFloat(data.current_value) * (9/5)) + 32);
        }
        out.setValueAnimated( parseFloat(data.current_value) );
        break;
      default:
        console.log("default")
      }
      if (PoolC_series.length == OutC_series.length) {
        drawgraphifready(PoolC_series , OutC_series , (PoolC_serie_min < OutC_serie_min)?PoolC_serie_min:OutC_serie_min, (PoolC_serie_max > OutC_serie_max)?PoolC_serie_max:OutC_serie_max , "#chartC");
      }
      if (PoolF_series.length == OutF_series.length) {
        drawgraphifready(PoolF_series , OutF_series , (PoolF_serie_min < OutF_serie_min)?PoolF_serie_min:OutF_serie_min, (PoolF_serie_max > OutF_serie_max)?PoolF_serie_max:OutF_serie_max ,"#chartF");
      }
  }


  xively.datastream.history( "302281936", "PoolTemperature", queryWeekly, loadDataW);
  xively.datastream.history( "302281936", "ExteriorTemperature", queryWeekly, loadDataW);

  function loadDataW(data) {
    var filtedData = data.datapoints;
    for (var i=0; i < filtedData.length; i++ ) {
      var date = moment(filtedData[i].at);
      var value = parseFloat(filtedData[i].value);
      switch (data.id) {
        case "PoolTemperature":
          PoolC_seriesW[i] = {x: date.unix(), y: value};
          if (value < PoolC_serieW_min) {
            PoolC_serieW_min = value;
            PoolF_serieW_min = ((value * (9/5)) + 32);
          }
          if (value > PoolC_serieW_max) {
            PoolC_serieW_max = value;
            PoolF_serieW_max = ((value * (9/5)) + 32);
          }
          PoolF_seriesW[i] = {x: date.unix(), y: ((value * (9/5)) + 32)};
          break;
        case "ExteriorTemperature":
          OutC_seriesW[i] = {x: date.unix(), y: value};
          if (value < OutC_serieW_min) {
            OutC_serieW_min = value;
            OutF_serieW_min = ((value * (9/5)) + 32);
          }
          if (value > OutC_serieW_max) {
            OutC_serieW_max = value;
            OutF_serieW_max = ((value * (9/5)) + 32);
          }
          OutF_seriesW[i] = {x: date.unix(), y: ((value * (9/5)) + 32)};
          break;
        default:
          console.log("default")
      }
    }

    switch (data.id) {
      case "PoolTemperature":
        if (parseFloat(data.current_value) < PoolC_serieW_min) {
          PoolC_serieW_min = parseFloat(data.current_value);
          PoolF_serieW_min = ((parseFloat(data.current_value) * (9/5)) + 32);
        }
        if (parseFloat(data.current_value) > PoolC_serieW_max) {
          PoolC_serieW_max = parseFloat(data.current_value);
          PoolF_serieW_max = ((parseFloat(data.current_value) * (9/5)) + 32);
        }
        break;
      case "ExteriorTemperature":
        if (parseFloat(data.current_value) < OutC_serieW_min) {
          OutC_serieW_min = parseFloat(data.current_value);
          OutF_serieW_min = ((parseFloat(data.current_value) * (9/5)) + 32);
        }
        if (parseFloat(data.current_value) > OutC_serieW_max) {
          OutC_serieW_max = parseFloat(data.current_value);
          OutF_serieW_max = ((parseFloat(data.current_value) * (9/5)) + 32);
        }
        break;
      default:
        console.log("default")
      }
      if (PoolC_seriesW.length == OutC_seriesW.length) {
        drawgraphifready(PoolC_seriesW , OutC_seriesW , (PoolC_serieW_min < OutC_serieW_min)?PoolC_serieW_min:OutC_serieW_min, (PoolC_serieW_max > OutC_serieW_max)?PoolC_serieW_max:OutC_serieW_max , "#chartCW");
      }
      if (PoolF_seriesW.length == OutF_seriesW.length) {
        drawgraphifready(PoolF_seriesW , OutF_seriesW , (PoolF_serieW_min < OutF_serieW_min)?PoolF_serieW_min:OutF_serieW_min, (PoolF_serieW_max > OutF_serieW_max)?PoolF_serieW_max:OutF_serieW_max ,"#chartFW");
      }
  }

  function drawgraphifready(serie1, serie2, min_val, max_val, anchor) {
    console.log("Entered drawgraphifready: " + serie1.length + " - " + serie2.length);
    if ((serie1.length > 0) && (serie2.length > 0)){
      var graph = new Rickshaw.Graph( {
        element: document.querySelector(anchor),
        width: 750,
        height: 320,
        renderer: 'line',
        min: min_val - (min_val % 5),
        max: max_val + (5 - (max_val % 5)),
  //      interpolation: 'basis',
        series: [
          {
            data: serie1,
            color: '#6060c0',
            name: "Piscine"
          },
          {
            data: serie2,
            color: '#FF0000',
            name: "Exterieur"
          },
        ]
      } );

      graph.render();

      var hoverDetail = new Rickshaw.Graph.HoverDetail( {
        graph: graph
      } );
/*
      var smoother = new Rickshaw.Graph.Smoother( {
	graph: graph,
	element: document.querySelector('#smoother')
      } );

      var ticksTreatment = 'glow';
*/
      var axes = new Rickshaw.Graph.Axis.Time( {
        graph: graph,
        //ticksTreatment: ticksTreatment,
	timeFixture: new Rickshaw.Fixtures.Time.Local()
      });
      axes.render();

      var yAxis = new Rickshaw.Graph.Axis.Y({
        graph: graph
      });

      yAxis.render();
    }
  }

  });

</script>

</head>

<body>

<!--<strong>Home</strong> - <a href="weekly.html">Weekly</a> - <a href="daily.html">Daily</a> - <a href="hourly.html">Hourly</a>-->

<div align="center" style="vertical-align:bottom">

<h2>Les derni&egrave;res 24 heures</h2>
<table width="70%">
  <tr>
    <td>
<table id="graph">
  <tr>
    <td>
      <div id="chart_container" >
        <div id="chartF"></div>
        <div id="legend_container">
          <div id="smoother" title="Smoothing"></div>
          <div id="legend"></div>
        </div>
      </div>
    </td>
    <td><canvas id=poolThermometerCanvas width=200 height=200>No canvas in your browser...sorry...</canvas></td>
  </tr>
  <tr>
    <td>
      <div id="chart_container" >
        <div id="chartC"></div>
          <div id="legend_container">
          <div id="timeline"></div>
          <div id="preview"></div>
          <div id="smoother" title="Smoothing"></div>
          <div id="legend"></div>
        </div>
      </div>
    </td>
    <td><canvas id=outThermometerCanvas width=200 height=200>No canvas in your browser...sorry...</canvas></td>
  </tr>
  <tr>
    <td>
      <div id="chart_container" >
        <div id="chartFW"></div>
        <div id="legend_container">
          <div id="smoother" title="Smoothing"></div>
          <div id="legend"></div>
        </div>
      </div>
    </td>
    <td><canvas id=poolThermometerCanvas width=200 height=200>No canvas in your browser...sorry...</canvas></td>
  </tr>
  <tr>
    <td>
      <div id="chart_container" >
        <div id="chartCW"></div>
          <div id="legend_container">
          <div id="timeline"></div>
          <div id="preview"></div>
          <div id="smoother" title="Smoothing"></div>
          <div id="legend"></div>
        </div>
      </div>
    </td>
    <td><canvas id=outThermometerCanvas width=200 height=200>No canvas in your browser...sorry...</canvas></td>
  </tr>


</table>
    </td>
  </tr>
</table>

<!--
<h2>La derni&egrave;re journ&eacute;e</h2>
<table width="70%">
  <tr>
    <td>
<table id="graph">
  <tr>
    <th align="center">Combin&eacute;e °C</th>
    <th align="center">Combin&eacute;e °F</th>
  <tr>
    <td>
      <div id="chart_container" >
        <div id="chartC"></div>
          <div id="legend_container">
          <div id="timeline"></div>
          <div id="preview"></div>
          <div id="smoother" title="Smoothing"></div>
          <div id="legend"></div>
        </div>
      </div>
    </td>
    <td>
      <div id="chart_container" >
        <div id="chartF"></div>
        <div id="legend_container">
          <div id="smoother" title="Smoothing"></div>
          <div id="legend"></div>
        </div>
      </div>
    </td>
  </tr>
</table>
    </td>
  </tr>
</table>

<h2>La derni&egrave;re semaine</h2>
<table width="70%">
  <tr>
    <td>
<table id="graph">
  <tr>
  <tr>
    <td>
      <div id="chart_container" >
        <div id="chartCW"></div>
        <div id="legend_container">
          <div id="smoother" title="Smoothing"></div>
          <div id="legend"></div>
        </div>
      </div>
    </td>
    <td>
      <div id="chart_container" >
        <div id="chartFw"></div>
        <div id="legend_container">
          <div id="smoother" title="Smoothing"></div>
          <div id="legend"></div>
        </div>
      </div>
    </td>
  </tr>
</table>
    </td>
  </tr>
</table>

-->

</body>
</html>
