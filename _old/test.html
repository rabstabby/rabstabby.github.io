<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="Xively-rickshaw : Some example time series graphs generated from Xively using Rickshaw" />

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">
    <link type="text/css" rel="stylesheet" href="css/graph.css">
    <link type="text/css" rel="stylesheet" href="css/detail.css">
    <link type="text/css" rel="stylesheet" href="css/legend.css">
    <link type="text/css" rel="stylesheet" href="css/lines.css">

    <script src="vendor/d3.min.js"></script>
    <script src="vendor/d3.layout.min.js"></script>

    <script src="rickshaw.min.js"></script>
    <script src="vendor/moment.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.15/jquery-ui.min.js"></script>
    <script src="http://d23cj0cdvyoxg0.cloudfront.net/xivelyjs-1.0.3.min.js"></script>  

    <title>Sensors</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <h1 id="project_title">Sensors</h1>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner" style="height: 500px">
      <table>
        <tr>
          <td>
            <div id="chart_container" >
              <div id="chartC"></div>
              <div id="legend_container">
                <div id="smoother" title="Smoothing"></div>
                <div id="legend"></div>
              </div>
              <div id="slider"></div>
            </div>
          </td>
          <td>
            <div id="chart_container" >
              <div id="chartF"></div>
              <div id="legend_container">
                <div id="smoother" title="Smoothing"></div>
                <div id="legend"></div>
              </div>
              <div id="slider"></div>
            </div>
          </td>
        </tr>
        <tr>
          <td>a2</td>
          <td>b2</td>
        </tr>
      </table>

<!--
      <div id="chart_container" >
          <div id="chart"></div>
          <div id="legend_container">
            <div id="smoother" title="Smoothing"></div>
            <div id="legend"></div>
          </div>
          <div id="slider"></div>
      </div>
-->
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">Xively-rickshaw maintained by <a href="https://github.com/jasonneylon">jasonneylon</a></p>
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

<script>

// Set your API key first  
xively.setKey( "SICanKXlrENyrCh3cYsdBZTjmoxH39kujPYRGnJGnZ7bVM8k" );  

var startOfYesterday = moment().subtract("day", 1).startOf('day');
var endOfYesterday = moment().subtract("hour", 3).startOf('day');
var PoolC_series = [];
var PoolF_series = [];
var OutC_series = [];
var OutF_series = [];

console.log(startOfYesterday);
console.log(endOfYesterday);

var query = { 
  start: startOfYesterday.toJSON(), 
  end: endOfYesterday.toJSON(), 
  interval: 120, 
  limit: 1000,
};


xively.datastream.history( "302281936", "PoolTemperature", query, loadData);
xively.datastream.history( "302281936", "ExteriorTemperature", query, loadData);
xively.datastream.history( "302281936", "PoolTemperatureF", query, loadData);
xively.datastream.history( "302281936", "ExteriorTemperatureF", query, loadData);

function loadData(data) {
  //var unit = data.unit.label;
  var filtedData = data.datapoints;
  for (var i=0; i < filtedData.length; i++ ) {
    var date = moment(filtedData[i].at);
    var value = parseInt(filtedData[i].value);
    switch (data.id) {
      case "PoolTemperature":
        PoolC_series[i] = {x: date.unix(), y: value};
        if (PoolC_series.length == OutC_series.length) {
          drawgraphifready(PoolC_series , OutC_series , "#chartC");
        }
        break;
      case "PoolTemperatureF":
        PoolF_series[i] = {x: date.unix(), y: value}; 
        if (PoolF_series.length == OutF_series.length) {
          drawgraphifready(PoolF_series , OutF_series , "#chartF");
        }
        break;
      case "ExteriorTemperature":
        OutC_series[i] = {x: date.unix(), y: value};i
        if (PoolC_series.length == OutC_series.length) {
          drawgraphifready(PoolC_series , OutC_series , "#chartC");
        }
        break;
      case "ExteriorTemperatureF":
        OutF_series[i] = {x: date.unix(), y: value};
        if (PoolF_series.length == OutF_series.length) {
          drawgraphifready(PoolF_series , OutF_series , "#chartF");
        }
        break;
      default:
        console.log("default")
    }
  }
}







/*
  var unit = data.unit.label;
  var filtedData = data.datapoints;
  for (var i=0; i < filtedData.length; i++ ) {
    var date = moment(filtedData[i].at);
    var value = parseInt(filtedData[i].value);
    serie1[i] = {x: date.unix(), y: value};
  }

  drawgraphifready(serie1, serie2, anchor);
}
*/

/*
xively.datastream.history( "302281936", "PoolTemperature", query, loadDataPoolC);  

function loadDataPoolC(data) {  
  var unit = data.unit.label;
  var filtedData = data.datapoints;
  for (var i=0; i < filtedData.length; i++ ) {
    var date = moment(filtedData[i].at);
    var value = parseInt(filtedData[i].value);
    PoolC_series[i] = {x: date.unix(), y: value};
  }
  drawgraphifready(PoolC_series , OutC_series , "#chart");
}
*/
/*
xively.datastream.history( "302281936", "ExteriorTemperature", query, loadDataOutC);

function loadDataOutC(data) {
  var unit = data.unit.label;
  var filtedData = data.datapoints;
  for (var i=0; i < filtedData.length; i++ ) {
    var date = moment(filtedData[i].at);
    var value = parseInt(filtedData[i].value);
    OutC_series[i] = {x: date.unix(), y: value};
  }
  drawgraphifready(PoolC_series , OutC_series , "#chart");
}
*/

function drawgraphifready(serie1, serie2, anchor) {
  console.log("Entered drawgraphifready: " + serie1.length + " - " + serie2.length);
  if ((serie1.length > 0) && (serie2.length > 0)){
    var graph = new Rickshaw.Graph( {
      element: document.querySelector(anchor),
      width: 640,
      height: 400,
      renderer: 'line',
//      interpolation: 'basis',
      series: [
        {
          data: serie1,
          color: '#6060c0',
          name: "Piscine"
        },
        {
          data: serie2,
          color: '#FF0000',
          name: "Exterieur"
        },
      ]
    } );

    graph.render();

    var hoverDetail = new Rickshaw.Graph.HoverDetail( {
      graph: graph
    } );

/*
    var legend = new Rickshaw.Graph.Legend( {
      graph: graph,
      element: document.getElementById('legend')
    } );

    var shelving = new Rickshaw.Graph.Behavior.Series.Toggle( {
      graph: graph,
      legend: legend
    } );
*/
    var axes = new Rickshaw.Graph.Axis.Time( {
      graph: graph
    });
    axes.render();
  
    var yAxis = new Rickshaw.Graph.Axis.Y({
      graph: graph
    });

    yAxis.render();
  }
}

</script>
</body>
</html>
